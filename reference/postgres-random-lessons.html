
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efficient Random Row Selection in PostgreSQL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tiempos+Headline:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        .font-tiempos { font-family: 'Tiempos Headline', serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .hero-overlay {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(30, 58, 138, 0.7) 100%);
        }
        .toc-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: white;
            border-right: 1px solid #e5e7eb;
            z-index: 40;
            overflow-y: auto;
            padding: 2rem 1.5rem;
        }
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }
        .toc-link {
            transition: all 0.2s ease;
        }
        .toc-link:hover {
            color: #1e3a8a;
            background-color: #f3f4f6;
            padding-left: 0.75rem;
        }
        .toc-link.active {
            color: #1e3a8a;
            background-color: #eff6ff;
            border-left: 3px solid #1e3a8a;
            padding-left: 0.75rem;
        }
        .code-block {
            background: #1f2937;
            border-radius: 8px;
            overflow: hidden;
        }
        .citation-link {
            color: #1e3a8a;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .citation-link:hover {
            color: #1e40af;
            text-decoration: underline;
        }
        .performance-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .method-comparison {
            border-left: 4px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .method-comparison:hover {
            border-left-color: #1e3a8a;
        }

        /* Mermaid diagram styling */
        .mermaid-container {
            display: flex;
            justify-content: center;
            min-height: 300px;
            max-height: 800px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .mermaid-container .mermaid {
            width: 100%;
            max-width: 100%;
            height: 100%;
            cursor: grab;
            transition: transform 0.3s ease;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .mermaid-container .mermaid svg {
            max-width: 100%;
            height: 100%;
            display: block;
            margin: 0 auto;
        }

        .mermaid-container .mermaid:active {
            cursor: grabbing;
        }

        .mermaid-container.zoomed .mermaid {
            height: 100%;
            width: 100%;
            cursor: grab;
        }

        .mermaid-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mermaid-control-btn {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            font-size: 14px;
            min-width: 36px;
            height: 36px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mermaid-control-btn:hover {
            background: #f8fafc;
            border-color: #3b82f6;
            color: #3b82f6;
            transform: translateY(-1px);
        }

        .mermaid-control-btn:active {
            transform: scale(0.95);
        }

        /* Override mermaid default styles for better contrast and unified styling */
        .mermaid .node rect,
        .mermaid .node circle,
        .mermaid .node ellipse,
        .mermaid .node polygon {
            stroke-width: 2px !important;
        }

        .mermaid .node .label {
            color: #1f2937 !important;
            font-weight: 500 !important;
            font-size: 13px !important;
            font-family: 'Inter', sans-serif !important;
        }

        .mermaid .edgePath .path {
            stroke-width: 2px !important;
            stroke: #6b7280 !important;
        }

        .mermaid .edgeLabel {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            font-family: 'Inter', sans-serif !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
            color: #374151 !important;
            font-weight: 500 !important;
        }

        .mermaid .cluster rect {
            fill: #f8fafc !important;
            stroke: #d1d5db !important;
            stroke-width: 1px !important;
            stroke-dasharray: 5,5 !important;
        }

        .mermaid .cluster .label {
            color: #374151 !important;
            font-weight: 600 !important;
            background-color: rgba(255, 255, 255, 0.9) !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            border: 1px solid #d1d5db !important;
        }

        /* Ensure proper contrast for different node types */
        .mermaid .node[style*="fill:#dbeafe"] .label {
            color: #1e40af !important;
            font-weight: 600 !important;
        }

        .mermaid .node[style*="fill:#fef3c7"] .label {
            color: #92400e !important;
            font-weight: 600 !important;
        }

        .mermaid .node[style*="fill:#dcfce7"] .label {
            color: #166534 !important;
            font-weight: 600 !important;
        }

        .mermaid .node[style*="fill:#fee2e2"] .label {
            color: #b91c1c !important;
            font-weight: 600 !important;
        }

        @media (max-width: 1024px) {
            .mermaid-control-btn:not(.reset-zoom) {
                display: none;
            }
            .mermaid-controls {
                top: auto;
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
  <base target="_blank">
</head>

  <body class="bg-gray-50 font-inter">
    <!-- Table of Contents - Fixed Left Sidebar -->
    <div class="toc-fixed">
      <div class="mb-6">
        <h2 class="font-tiempos text-xl font-bold text-gray-900 mb-2">Contents</h2>
        <div class="w-12 h-0.5 bg-blue-900"></div>
      </div>
      <nav class="space-y-2">
        <a href="#executive-summary" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">Executive Summary</a>
        <a href="#recommended-solution" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">1. Recommended Solution</a>
        <div class="ml-4 space-y-1">
          <a href="#core-strategy" class="toc-link block py-1 px-3 text-xs text-gray-600 rounded-md">Core Strategy</a>
          <a href="#implementation-details" class="toc-link block py-1 px-3 text-xs text-gray-600 rounded-md">Implementation</a>
          <a href="#performance-tradeoffs" class="toc-link block py-1 px-3 text-xs text-gray-600 rounded-md">Performance & Trade-offs</a>
        </div>
        <a href="#alternative-method-1" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">2. Alternative Method: ID-Based</a>
        <a href="#alternative-method-2" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">3. Alternative Method: Recursive CTE</a>
        <a href="#inefficient-methods" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">4. Inefficient Methods</a>
        <a href="#performance-analysis" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">5. Performance Analysis</a>
        <a href="#conclusion" class="toc-link block py-2 px-3 text-sm font-medium text-gray-700 rounded-md">6. Conclusion</a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Hero Section -->
      <section class="relative bg-white">
        <div class="container mx-auto px-6 py-16">
          <!-- Bento Grid Layout -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
            <!-- Main Title Block -->
            <div class="lg:col-span-8 relative overflow-hidden rounded-2xl">
              <div class="hero-overlay absolute inset-0"></div>
              <div class="relative z-10 p-6 md:p-12">
                <div class="mb-6">
                  <span class="inline-block px-3 py-1 bg-white/20 text-white text-sm font-medium rounded-full backdrop-blur-sm">
                    Database Optimization
                  </span>
                </div>
                <h1 class="font-tiempos text-3xl md:text-4xl lg:text-5xl font-bold text-white leading-tight mb-6 break-words">
                  <em class="not-italic">Efficient Random Row Selection</em>
                  <br>
                  in PostgreSQL for Large Tables
                </h1>
                <p class="text-base md:text-xl text-blue-100 leading-relaxed break-words">
                  A comprehensive analysis of optimized strategies for selecting random records from a 12-million-row table environment
                </p>
                <div class="mt-8 flex items-center space-x-6 text-blue-200">
                  <div class="flex items-center space-x-2">
                    <i class="fas fa-database text-lg"></i>
                    <span class="text-sm font-medium">PostgreSQL 17</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <i class="fas fa-table text-lg"></i>
                    <span class="text-sm font-medium">12M+ Rows</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <i class="fas fa-clock text-lg"></i>
                    <span class="text-sm font-medium">Milliseconds</span>
                  </div>
                </div>
              </div>
              <img src="https://kimi-img.moonshot.cn/pub/icon/spinner.svg" alt="Database server rack with blue LED lighting" class="absolute inset-0 w-full h-full object-cover opacity-30" size="wallpaper" aspect="wide" color="blue" style="photo" query="database server rack" referrerpolicy="no-referrer" />
            </div>

            <!-- Key Metrics Block -->
            <div class="lg:col-span-4 space-y-4">
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-tiempos text-lg font-bold text-gray-900">Performance Target</h3>
                  <i class="fas fa-rocket text-blue-600 text-xl"></i>
                </div>
                <div class="text-3xl font-bold text-blue-900 mb-2">10-100ms</div>
                <p class="text-sm text-gray-600">Target query execution time for random row selection</p>
              </div>

              <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-tiempos text-lg font-bold text-gray-900">Data Scale</h3>
                  <i class="fas fa-chart-line text-gray-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-2">12 Million</div>
                <p class="text-sm text-gray-600">Rows in the `inode` table requiring optimization</p>
              </div>

              <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-tiempos text-lg font-bold text-gray-900">Efficiency Gain</h3>
                  <i class="fas fa-tachometer-alt text-green-600 text-xl"></i>
                </div>
                <div class="text-2xl font-bold text-green-900 mb-2">10,000x</div>
                <p class="text-sm text-gray-600">Performance improvement over naive methods</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Executive Summary -->
      <section id="executive-summary" class="bg-white py-16">
        <div class="container mx-auto px-6">
          <div class="max-w-4xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-8">Executive Summary</h2>

            <div class="bg-blue-50 border-l-4 border-blue-600 p-6 mb-8">
              <div class="flex items-start space-x-3">
                <i class="fas fa-lightbulb text-blue-600 text-xl mt-1"></i>
                <div>
                  <h3 class="font-semibold text-gray-900 mb-2">Key Finding</h3>
                  <p class="text-gray-700 leading-relaxed">
                    The most efficient method to select a single random record from a large PostgreSQL table is a <strong>hybrid approach</strong> combining the speed of
                    <code class="bg-white px-2 py-1 rounded text-sm font-mono">TABLESAMPLE SYSTEM_ROWS</code> with the true randomness of
                    <code class="bg-white px-2 py-1 rounded text-sm font-mono">ORDER BY RANDOM()</code>.
                  </p>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-bolt text-blue-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">Speed First</h3>
                <p class="text-sm text-gray-600">Uses block-level sampling to quickly grab a small subset of ~100 rows</p>
              </div>
              <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-random text-green-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">True Randomness</h3>
                <p class="text-sm text-gray-600">Applies random sorting only to the small sample for genuine randomness</p>
              </div>
              <div class="text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <i class="fas fa-cogs text-purple-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">Production Ready</h3>
                <p class="text-sm text-gray-600">Integrates seamlessly with filters, joins, and locking mechanisms</p>
              </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Recommended Solution Benefits</h3>
              <ul class="space-y-2 text-gray-700">
                <li class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-600 mt-1"></i>
                  <span>Avoids full table scan and expensive sort operations</span>
                </li>
                <li class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-600 mt-1"></i>
                  <span>Maintains compatibility with existing WHERE clauses and JOIN operations</span>
                </li>
                <li class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-600 mt-1"></i>
                  <span>Supports concurrent processing with FOR UPDATE SKIP LOCKED</span>
                </li>
                <li class="flex items-start space-x-2">
                  <i class="fas fa-check text-green-600 mt-1"></i>
                  <span>Scales efficiently with table size growth</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Recommended Solution -->
      <section id="recommended-solution" class="py-16 bg-white">
        <div class="container mx-auto px-6">
          <div class="max-w-6xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-12">1. Recommended Solution: Hybrid Sampling Approach</h2>

            <!-- Core Strategy -->
            <div id="core-strategy" class="mb-16">
              <h3 class="font-tiempos text-2xl font-bold text-gray-900 mb-8">1.1 Core Strategy: Combining Speed and True Randomness</h3>

              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-8 mb-8">
                <div class="flex items-start space-x-4">
                  <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-rocket text-white text-xl"></i>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900 mb-3">The Hybrid Advantage</h4>
                    <p class="text-gray-700 leading-relaxed">
                      The hybrid approach leverages <strong>TABLESAMPLE SYSTEM_ROWS</strong> for rapid, approximate sampling at the block level,
                      then applies <strong>ORDER BY RANDOM()</strong> to the small sampled subset. This strategy overcomes the prohibitive
                      cost of applying random sorting to the entire 12-million-row table <a href="#ref-25" class="citation-link">[25]</a>.
                    </p>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-database text-blue-600 mr-2"></i>
                    Step 1: Fast Block-Level Sampling
                  </h4>
                  <p class="text-gray-700 text-sm leading-relaxed mb-4">
                    The <code class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">TABLESAMPLE SYSTEM_ROWS(100)</code>
                    method operates at the physical storage level, randomly selecting data blocks from the table
                    <a href="#ref-453" class="citation-link">[453]</a>.
                  </p>
                  <ul class="text-sm text-gray-600 space-y-1">
                    <li>• Avoids full table scan</li>
                    <li>• Processes ~100 rows in milliseconds</li>
                    <li>• Works with table's physical layout</li>
                  </ul>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-random text-green-600 mr-2"></i>
                    Step 2: True Random Selection
                  </h4>
                  <p class="text-gray-700 text-sm leading-relaxed mb-4">
                    The <code class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">ORDER BY RANDOM() LIMIT 1</code>
                    is applied only to the small sampled subset, ensuring true randomness <a href="#ref-25" class="citation-link">[25]</a>.
                  </p>
                  <ul class="text-sm text-gray-600 space-y-1">
                    <li>• Complete randomization</li>
                    <li>• In-memory operation</li>
                    <li>• Negligible processing time</li>
                  </ul>
                </div>
              </div>

              <!-- Data Flow Diagram -->
              <div class="bg-gray-50 rounded-lg p-6 mb-8">
                <h4 class="font-semibold text-gray-900 mb-4">Hybrid Sampling Data Flow</h4>
                <div class="mermaid-container">
                  <div class="mermaid-controls">
                    <button class="mermaid-control-btn zoom-in" title="放大">
                      <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="mermaid-control-btn zoom-out" title="缩小">
                      <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="mermaid-control-btn reset-zoom" title="重置">
                      <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="mermaid-control-btn fullscreen" title="全屏查看">
                      <i class="fas fa-expand"></i>
                    </button>
                  </div>
                  <div class="mermaid" id="hybrid-flow-chart">
                    graph LR
                    A["12M Row Table"] --> B["TABLESAMPLE
                    <br />SYSTEM_ROWS100"]
                    B --> C["~100 Row Sample"]
                    C --> D["WHERE copied = false"]
                    D --> E["JOIN with path"]
                    E --> F["ORDER BY RANDOM"]
                    F --> G["LIMIT 1 Final Row"]

                    style A fill:#dbeafe,stroke:#1e40af,stroke-width:2px,color:#1e40af
                    style B fill:#fef3c7,stroke:#d97706,stroke-width:2px,color:#92400e
                    style C fill:#dcfce7,stroke:#16a34a,stroke-width:2px,color:#166534
                    style D fill:#f3e8ff,stroke:#9333ea,stroke-width:2px,color:#7c3aed
                    style E fill:#fce7f3,stroke:#db2777,stroke-width:2px,color:#be185d
                    style F fill:#fed7aa,stroke:#ea580c,stroke-width:2px,color:#c2410c
                    style G fill:#f0fdf4,stroke:#22c55e,stroke-width:3px,color:#15803d
                  </div>
                </div>
              </div>
            </div>

            <!-- Implementation Details -->
            <div id="implementation-details" class="mb-16">
              <h3 class="font-tiempos text-2xl font-bold text-gray-900 mb-8">1.2 Implementation Details</h3>

              <div class="space-y-8">
                <!-- tsm_system_rows Extension -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-puzzle-piece text-purple-600 mr-2"></i>
                    The tsm_system_rows Extension
                  </h4>
                  <p class="text-gray-700 mb-4">
                    The
                    <code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">tsm_system_rows</code> extension
                    provides the critical
                    <code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">SYSTEM_ROWS</code> sampling method
                    not available in standard PostgreSQL <a href="#ref-443" class="citation-link">[443]</a>.
                  </p>
                  <div class="code-block p-4 mb-4">
                    <pre class="text-green-400 text-sm overflow-x-auto"><code>-- Enable the extension
CREATE EXTENSION tsm_system_rows;</code></pre>
                  </div>
                  <p class="text-sm text-gray-600">
                    This extension enables exact row count specification, making it ideal for our hybrid approach.
                  </p>
                </div>

                <!-- Optimal Sample Size -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-target text-orange-600 mr-2"></i>
                    Determining Optimal Sample Size
                  </h4>
                  <p class="text-gray-700 mb-4">
                    The sample size must balance speed with the probability of finding valid rows. A starting point of
                    100 rows provides a reasonable compromise <a href="#ref-453" class="citation-link">[453]</a>.
                  </p>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                      <h5 class="font-medium text-green-900 mb-2">Small Sample (10-20 rows)</h5>
                      <p class="text-sm text-green-700">Best when copied=false is common (&gt;50% of rows)</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <h5 class="font-medium text-blue-900 mb-2">Large Sample (100-200 rows)</h5>
                      <p class="text-sm text-blue-700">Necessary when copied=false is rare (&lt;5% of rows)</p>
                    </div>
                  </div>
                </div>

                <!-- Final Query Structure -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-code text-blue-600 mr-2"></i>
                    Complete Query Implementation
                  </h4>
                  <div class="code-block p-4">
                    <pre class="text-green-400 text-sm overflow-x-auto"><code>-- Hybrid sampling with CTE for clarity
WITH sampled_inodes AS (
    SELECT i.*
    FROM inode i TABLESAMPLE SYSTEM_ROWS(100)
    WHERE i.copied = false
)
SELECT i.*, p.path
FROM sampled_inodes i
JOIN path p ON (
    i.medium_hash = p.medium_hash AND
    i.dev = p.dev AND
    i.ino = p.ino
)
ORDER BY RANDOM()
LIMIT 1
FOR UPDATE OF i SKIP LOCKED;</code></pre>
                  </div>
                  <p class="text-sm text-gray-600 mt-4">
                    This structure ensures optimal performance by applying filtering and joining to the smallest possible dataset.
                  </p>
                </div>
              </div>
            </div>

            <!-- Performance and Trade-offs -->
            <div id="performance-tradeoffs" class="mb-16">
              <h3 class="font-tiempos text-2xl font-bold text-gray-900 mb-8">1.3 Performance and Trade-offs</h3>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Performance Gains -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                  <h4 class="font-semibold text-green-900 mb-4 flex items-center">
                    <i class="fas fa-chart-line text-green-600 mr-2"></i>
                    Performance Gains
                  </h4>
                  <ul class="space-y-3 text-sm text-green-800">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-check-circle text-green-600 mt-1"></i>
                      <span><strong>10,000x+ faster</strong> than ORDER BY RANDOM() <a href="#ref-443" class="citation-link">[443]</a></span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-check-circle text-green-600 mt-1"></i>
                      <span>Avoids full table scan and expensive sort operations</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-check-circle text-green-600 mt-1"></i>
                      <span>Operates within available memory constraints</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-check-circle text-green-600 mt-1"></i>
                      <span>Scales efficiently with table size growth</span>
                    </li>
                  </ul>
                </div>

                <!-- Trade-offs -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-6">
                  <h4 class="font-semibold text-amber-900 mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle text-amber-600 mr-2"></i>
                    Considerations
                  </h4>
                  <ul class="space-y-3 text-sm text-amber-800">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-info-circle text-amber-600 mt-1"></i>
                      <span>May return no rows if sample size is too small</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-info-circle text-amber-600 mt-1"></i>
                      <span>Requires tsm_system_rows extension installation</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-info-circle text-amber-600 mt-1"></i>
                      <span>Sample size needs tuning based on data distribution</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-info-circle text-amber-600 mt-1"></i>
                      <span>Block-level sampling may introduce minor bias</span>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Mitigation Strategies -->
              <div class="bg-blue-50 rounded-lg p-6 mt-8">
                <h4 class="font-semibold text-blue-900 mb-4">Mitigation Strategies</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h5 class="font-medium text-blue-800 mb-2">No Rows Returned</h5>
                    <p class="text-sm text-blue-700">Implement retry logic with progressively larger sample sizes or maintain a fallback method for edge cases.</p>
                  </div>
                  <div>
                    <h5 class="font-medium text-blue-800 mb-2">Block-Level Bias</h5>
                    <p class="text-sm text-blue-700">The final ORDER BY RANDOM() on the sample mitigates most block-level sampling bias effectively.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Alternative Method 1: ID-Based Sampling -->
      <section id="alternative-method-1" class="py-16 bg-gray-50">
        <div class="container mx-auto px-6">
          <div class="max-w-6xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-12">2. Alternative Method 1: ID-Based Sampling with Random Offset</h2>

            <div class="method-comparison bg-white p-8 rounded-xl mb-12">
              <div class="flex items-center justify-between mb-6">
                <h3 class="font-semibold text-gray-900 text-lg">Method Comparison</h3>
                <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Alternative</span>
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Indexed Required</span>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                  <h4 class="font-medium text-gray-900 mb-3">Core Strategy</h4>
                  <p class="text-gray-700 text-sm leading-relaxed mb-4">
                    Leverages an indexed column (preferably a sequential primary key) to efficiently jump to a random
                    location within the table using LIMIT and OFFSET clauses <a href="#ref-456" class="citation-link">[456]</a>.
                  </p>
                  <div class="code-block p-3 mb-4">
                    <pre class="text-green-400 text-xs overflow-x-auto"><code>LIMIT 1 OFFSET FLOOR(RANDOM() * COUNT(*))</code></pre>
                  </div>
                </div>

                <div>
                  <h4 class="font-medium text-gray-900 mb-3">Requirements</h4>
                  <ul class="text-sm text-gray-700 space-y-2">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-key text-blue-600 mt-1"></i>
                      <span>Sequential, numeric indexed column</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-chart-bar text-green-600 mt-1"></i>
                      <span>Accurate row count estimation</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-filter text-purple-600 mt-1"></i>
                      <span>WHERE clause compatibility</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Implementation Example -->
            <div class="bg-white rounded-xl p-8 mb-12">
              <h3 class="font-semibold text-gray-900 mb-6">Implementation Example</h3>
              <div class="code-block p-4 mb-6">
                <pre class="text-green-400 text-sm overflow-x-auto"><code>-- ID-based sampling with random offset
SELECT i.*, p.path
FROM (
    SELECT *
    FROM inode
    WHERE copied = false
    ORDER BY ino
    LIMIT 1
    OFFSET (
        SELECT FLOOR(random() * COUNT(*))
        FROM inode
        WHERE copied = false
    )
) i
JOIN path p ON (
    i.medium_hash = p.medium_hash AND
    i.dev = p.dev AND
    i.ino = p.ino
)
FOR UPDATE OF i SKIP LOCKED;</code></pre>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-green-50 p-4 rounded-lg">
                  <h4 class="font-medium text-green-900 mb-2">Advantages</h4>
                  <ul class="text-sm text-green-800 space-y-1">
                    <li>• Very fast with proper indexes</li>
                    <li>• Simple implementation</li>
                    <li>• No extensions required</li>
                    <li>• Good randomness with dense IDs</li>
                  </ul>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                  <h4 class="font-medium text-red-900 mb-2">Limitations</h4>
                  <ul class="text-sm text-red-800 space-y-1">
                    <li>• Bias from gaps in IDs</li>
                    <li>• Costly COUNT(*) operation</li>
                    <li>• Requires sequential numeric ID</li>
                    <li>• Complex with composite keys</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Alternative Method 2: Recursive CTE -->
      <section id="alternative-method-2" class="py-16 bg-white">
        <div class="container mx-auto px-6">
          <div class="max-w-6xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-12">3. Alternative Method 2: Recursive CTE for True Randomness</h2>

            <div class="method-comparison bg-gray-50 p-8 rounded-xl mb-12">
              <div class="flex items-center justify-between mb-6">
                <h3 class="font-semibold text-gray-900 text-lg">Advanced Recursive Approach</h3>
                <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Advanced</span>
                  <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">High Randomness</span>
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                  <h4 class="font-medium text-gray-900 mb-3">Core Strategy</h4>
                  <p class="text-gray-700 text-sm leading-relaxed mb-4">
                    Uses a recursive Common Table Expression (CTE) to generate random candidate IDs and efficiently
                    handle gaps in the primary key sequence <a href="#ref-69" class="citation-link">[69]</a>.
                  </p>
                  <div class="bg-purple-50 p-3 rounded-lg">
                    <p class="text-sm text-purple-800">
                      <strong>Key Benefit:</strong> Handles gaps gracefully while maintaining true randomness
                    </p>
                  </div>
                </div>

                <div>
                  <h4 class="font-medium text-gray-900 mb-3">Requirements</h4>
                  <ul class="text-sm text-gray-700 space-y-2">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-key text-purple-600 mt-1"></i>
                      <span>Unique, preferably numeric identifier</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-recycle text-blue-600 mt-1"></i>
                      <span>Recursive query capability</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-memory text-orange-600 mt-1"></i>
                      <span>Adequate memory for CTE operations</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Advanced Implementation -->
            <div class="bg-white border border-gray-200 rounded-xl p-8 mb-12">
              <h3 class="font-semibold text-gray-900 mb-6">Advanced Implementation</h3>

              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                <h4 class="font-medium text-purple-900 mb-2">Function-Based Approach</h4>
                <p class="text-sm text-purple-800">
                  The
                  <code class="bg-purple-100 px-2 py-1 rounded text-xs">f_random_sample</code> function
                  provides a robust, generic implementation of the recursive CTE method <a href="#ref-69" class="citation-link">[69]</a>.
                </p>
              </div>

              <div class="code-block p-4 mb-6">
                <pre class="text-green-400 text-sm overflow-x-auto"><code>-- Simplified recursive CTE approach
WITH RECURSIVE random_candidates AS (
    -- Base case: Generate initial random IDs
    SELECT TRUNC(RANDOM() * (SELECT MAX(id) FROM table))::bigint as candidate_id
    FROM generate_series(1, 100)

    UNION

    -- Recursive case: Generate more candidates if needed
    SELECT TRUNC(RANDOM() * (SELECT MAX(id) FROM table))::bigint
    FROM random_candidates
    WHERE (SELECT COUNT(*) FROM random_candidates) < 10
)
SELECT t.*
FROM random_candidates rc
JOIN table t ON t.id = rc.candidate_id
LIMIT 1;</code></pre>
              </div>

              <!-- Suitability Analysis -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                <h4 class="font-medium text-yellow-900 mb-4">Suitability for inode Table</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h5 class="font-medium text-yellow-800 mb-2">Challenges</h5>
                    <ul class="text-sm text-yellow-700 space-y-1">
                      <li>• Composite primary key (medium_hash, dev, ino)</li>
                      <li>• Complex adaptation required</li>
                      <li>• Additional mapping table needed</li>
                      <li>• Higher implementation complexity</li>
                    </ul>
                  </div>
                  <div>
                    <h5 class="font-medium text-yellow-800 mb-2">Potential Solutions</h5>
                    <ul class="text-sm text-yellow-700 space-y-1">
                      <li>• Add surrogate integer primary key</li>
                      <li>• Create mapping table for composite keys</li>
                      <li>• Use hash-based approach for key generation</li>
                      <li>• Consider schema modification</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Inefficient Methods -->
      <section id="inefficient-methods" class="py-16 bg-gray-50">
        <div class="container mx-auto px-6">
          <div class="max-w-6xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-12">4. Inefficient and Discarded Methods</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- ORDER BY RANDOM() -->
              <div class="bg-red-50 border border-red-200 rounded-xl p-8">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="font-semibold text-red-900 text-lg">ORDER BY RANDOM()</h3>
                  <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Inefficient</span>
                </div>

                <div class="bg-red-100 rounded-lg p-4 mb-6">
                  <h4 class="font-medium text-red-900 mb-2">Why It's Slow</h4>
                  <p class="text-sm text-red-800">
                    Requires full table scan (12M rows) + random value generation + complete sort operation
                    <a href="#ref-423" class="citation-link">[423]</a>.
                  </p>
                </div>

                <div class="space-y-4">
                  <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-medium text-red-900 mb-2">Performance Impact</h5>
                    <ul class="text-sm text-red-800 space-y-1">
                      <li>• ~4.8-5.4 seconds on 12M rows</li>
                      <li>• Linear scaling with table size</li>
                      <li>• High memory consumption</li>
                      <li>• Potential disk I/O for sorting</li>
                    </ul>
                  </div>

                  <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-medium text-red-900 mb-2">Resource Usage</h5>
                    <ul class="text-sm text-red-800 space-y-1">
                      <li>• Full CPU utilization</li>
                      <li>• Large work_mem requirements</li>
                      <li>• Impact on concurrent queries</li>
                      <li>• Temporary file usage likely</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Naive TABLESAMPLE -->
              <div class="bg-orange-50 border border-orange-200 rounded-xl p-8">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="font-semibold text-orange-900 text-lg">Naive TABLESAMPLE</h3>
                  <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Limited</span>
                </div>

                <div class="bg-orange-100 rounded-lg p-4 mb-6">
                  <h4 class="font-medium text-orange-900 mb-2">The WHERE Clause Problem</h4>
                  <p class="text-sm text-orange-800">
                    TABLESAMPLE is applied before WHERE filtering, often returning empty results with selective conditions
                    <a href="#ref-422" class="citation-link">[422]</a>.
                  </p>
                </div>

                <div class="space-y-4">
                  <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-medium text-orange-900 mb-2">Execution Order Issues</h5>
                    <ul class="text-sm text-orange-800 space-y-1">
                      <li>• Physical sampling before logical filtering</li>
                      <li>• High chance of empty results</li>
                      <li>• Independent sampling in JOINs</li>
                      <li>• Block-level operation limitations</li>
                    </ul>
                  </div>

                  <div class="bg-white p-4 rounded-lg">
                    <h5 class="font-medium text-orange-900 mb-2">Workarounds Required</h5>
                    <ul class="text-sm text-orange-800 space-y-1">
                      <li>• Subqueries for pre-filtering</li>
                      <li>• Significantly larger sample sizes</li>
                      <li>• Complex query restructuring</li>
                      <li>• Performance trade-offs</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Other Rejected Ideas -->
            <div class="bg-white rounded-xl p-8 mt-8">
              <h3 class="font-semibold text-gray-900 mb-6">Other Considered but Rejected Ideas</h3>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                  <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-map-marker-alt text-gray-600"></i>
                  </div>
                  <h4 class="font-medium text-gray-900 mb-2">ctid-based Sampling</h4>
                  <p class="text-sm text-gray-600">Unstable physical identifiers that change with table maintenance operations</p>
                </div>

                <div class="text-center">
                  <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-database text-gray-600"></i>
                  </div>
                  <h4 class="font-medium text-gray-900 mb-2">Materialized Views</h4>
                  <p class="text-sm text-gray-600">High refresh costs and data staleness issues in dynamic environments</p>
                </div>

                <div class="text-center">
                  <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-mouse-pointer text-gray-600"></i>
                  </div>
                  <h4 class="font-medium text-gray-900 mb-2">Cursor Traversal</h4>
                  <p class="text-sm text-gray-600">Sequential access pattern ill-suited for random selection requirements</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Performance Analysis -->
      <section id="performance-analysis" class="py-16 bg-white">
        <div class="container mx-auto px-6">
          <div class="max-w-6xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-12">5. Performance Analysis</h2>

            <!-- Performance Comparison Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
              <div class="performance-card bg-green-50 border border-green-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-green-900">Hybrid Method</h3>
                  <i class="fas fa-trophy text-green-600 text-xl"></i>
                </div>
                <div class="text-3xl font-bold text-green-900 mb-2">10-100ms</div>
                <p class="text-sm text-green-700 mb-4">Recommended solution performance</p>
                <div class="space-y-2">
                  <div class="flex items-center text-xs text-green-600">
                    <i class="fas fa-check mr-2"></i>
                    <span>Optimal memory usage</span>
                  </div>
                  <div class="flex items-center text-xs text-green-600">
                    <i class="fas fa-check mr-2"></i>
                    <span>True randomness</span>
                  </div>
                </div>
              </div>

              <div class="performance-card bg-blue-50 border border-blue-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-blue-900">ID-Based</h3>
                  <i class="fas fa-database text-blue-600 text-xl"></i>
                </div>
                <div class="text-3xl font-bold text-blue-900 mb-2">50-200ms</div>
                <p class="text-sm text-blue-700 mb-4">With proper indexing</p>
                <div class="space-y-2">
                  <div class="flex items-center text-xs text-blue-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Requires sequential IDs</span>
                  </div>
                  <div class="flex items-center text-xs text-blue-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Potential bias from gaps</span>
                  </div>
                </div>
              </div>

              <div class="performance-card bg-red-50 border border-red-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-semibold text-red-900">ORDER BY RANDOM()</h3>
                  <i class="fas fa-clock text-red-600 text-xl"></i>
                </div>
                <div class="text-3xl font-bold text-red-900 mb-2">4.8-5.4s</div>
                <p class="text-sm text-red-700 mb-4">For 12M rows</p>
                <div class="space-y-2">
                  <div class="flex items-center text-xs text-red-600">
                    <i class="fas fa-times mr-2"></i>
                    <span>Full table scan required</span>
                  </div>
                  <div class="flex items-center text-xs text-red-600">
                    <i class="fas fa-times mr-2"></i>
                    <span>Expensive sort operation</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Performance Diagram -->
            <div class="bg-gray-50 rounded-xl p-8 mb-12">
              <h3 class="font-semibold text-gray-900 mb-6">Performance Characteristics</h3>
              <div class="mermaid-container">
                <div class="mermaid-controls">
                  <button class="mermaid-control-btn zoom-in" title="放大">
                    <i class="fas fa-search-plus"></i>
                  </button>
                  <button class="mermaid-control-btn zoom-out" title="缩小">
                    <i class="fas fa-search-minus"></i>
                  </button>
                  <button class="mermaid-control-btn reset-zoom" title="重置">
                    <i class="fas fa-expand-arrows-alt"></i>
                  </button>
                  <button class="mermaid-control-btn fullscreen" title="全屏查看">
                    <i class="fas fa-expand"></i>
                  </button>
                </div>
                <div class="mermaid" id="performance-chart">
                  graph TB
                  A["12 Million Rows"] --> B{"Choose Method"}
                  B -->|"Hybrid"| C["TABLESAMPLE 100 rows
                  <br />+ ORDER BY RANDOM"]
                  B -->|"ID-Based"| D["Random Offset + LIMIT 1"]
                  B -->|"Naive"| E["ORDER BY RANDOM()"]

                  C --> F["10-100ms"]
                  D --> G["50-200ms
                  <br />+ COUNT(*) cost"]
                  E --> H["4.8-5.4 seconds"]

                  F --> I["✅ Recommended"]
                  G --> J["⚠️ Limited"]
                  H --> K["❌ Not Scalable"]

                  style A fill:#e5e7eb,stroke:#6b7280,stroke-width:2px,color:#374151
                  style B fill:#f8fafc,stroke:#64748b,stroke-width:2px,color:#334155
                  style C fill:#dcfce7,stroke:#16a34a,stroke-width:2px,color:#166534
                  style D fill:#fef3c7,stroke:#d97706,stroke-width:2px,color:#92400e
                  style E fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#b91c1c
                  style F fill:#dcfce7,stroke:#16a34a,stroke-width:3px,color:#166534
                  style G fill:#fef3c7,stroke:#d97706,stroke-width:2px,color:#92400e
                  style H fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#b91c1c
                  style I fill:#dcfce7,stroke:#16a34a,stroke-width:3px,color:#166534
                  style J fill:#fef3c7,stroke:#d97706,stroke-width:2px,color:#92400e
                  style K fill:#fee2e2,stroke:#dc2626,stroke-width:2px,color:#b91c1c
                </div>
              </div>
            </div>

            <!-- Scalability Analysis -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="bg-white border border-gray-200 rounded-xl p-6">
                <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                  <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                  Scalability Analysis
                </h3>
                <div class="space-y-4">
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">Hybrid Method</h4>
                    <p class="text-sm text-blue-800">
                      Scales sub-linearly. Sample size remains constant regardless of table growth,
                      maintaining consistent performance characteristics.
                    </p>
                  </div>
                  <div class="bg-orange-50 p-4 rounded-lg">
                    <h4 class="font-medium text-orange-900 mb-2">ID-Based Method</h4>
                    <p class="text-sm text-orange-800">
                      COUNT(*) operation scales linearly, though index helps.
                      Performance degrades with very large row counts.
                    </p>
                  </div>
                </div>
              </div>

              <div class="bg-white border border-gray-200 rounded-xl p-6">
                <h3 class="font-semibold text-gray-900 mb-4 flex items-center">
                  <i class="fas fa-memory text-green-600 mr-2"></i>
                  Memory Usage
                </h3>
                <div class="space-y-4">
                  <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-medium text-green-900 mb-2">Hybrid Method</h4>
                    <p class="text-sm text-green-800">
                      Minimal memory footprint. Operates on small, fixed-size samples
                      that easily fit in available work_mem.
                    </p>
                  </div>
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <h4 class="font-medium text-yellow-900 mb-2">Recursive CTE</h4>
                    <p class="text-sm text-yellow-800">
                      Higher memory usage for CTE operations.
                      Requires careful monitoring in memory-constrained environments.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Conclusion -->
      <section id="conclusion" class="py-16 bg-gray-50">
        <div class="container mx-auto px-6">
          <div class="max-w-4xl mx-auto">
            <h2 class="font-tiempos text-3xl font-bold text-gray-900 mb-8">6. Conclusion</h2>

            <div class="bg-white rounded-xl p-8 mb-8">
              <div class="flex items-start space-x-4 mb-6">
                <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-check text-white text-xl"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-gray-900 text-xl mb-3">Final Recommendation</h3>
                  <p class="text-gray-700 leading-relaxed">
                    The <strong>hybrid approach combining TABLESAMPLE SYSTEM_ROWS with ORDER BY RANDOM()</strong>
                    represents the optimal balance of performance, randomness quality, and practical implementation
                    for selecting random records from large PostgreSQL tables.
                  </p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <h4 class="font-medium text-gray-900">Key Advantages</h4>
                  <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-rocket text-green-600 mt-1"></i>
                      <span><strong>10,000x+ performance improvement</strong> over naive methods</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-random text-blue-600 mt-1"></i>
                      <span>Maintains <strong>true randomness</strong> through two-stage process</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-cogs text-purple-600 mt-1"></i>
                      <span>Integrates seamlessly with existing <strong>filters and joins</strong></span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-lock text-orange-600 mt-1"></i>
                      <span>Supports <strong>concurrent processing</strong> with SKIP LOCKED</span>
                    </li>
                  </ul>
                </div>

                <div class="space-y-4">
                  <h4 class="font-medium text-gray-900">Implementation Notes</h4>
                  <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-download text-green-600 mt-1"></i>
                      <span>Requires
                        <code class="bg-gray-100 px-1 rounded">tsm_system_rows</code> extension
                      </span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-sliders-h text-blue-600 mt-1"></i>
                      <span>Sample size may need tuning based on data distribution</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-redo text-purple-600 mt-1"></i>
                      <span>Implement retry logic for edge cases with small sample sizes</span>
                    </li>
                    <li class="flex items-start space-x-2">
                      <i class="fas fa-chart-bar text-orange-600 mt-1"></i>
                      <span>Monitor performance and adjust based on production metrics</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Final Implementation -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-8">
              <h3 class="font-semibold text-blue-900 mb-4">Final Implementation for inode Table</h3>
              <div class="code-block p-4">
                <pre class="text-green-400 text-sm overflow-x-auto"><code>-- Enable extension (one-time setup)
CREATE EXTENSION IF NOT EXISTS tsm_system_rows;

-- Final optimized query
WITH sampled_inodes AS (
    SELECT i.*
    FROM inode i TABLESAMPLE SYSTEM_ROWS(100)
    WHERE i.copied = false
)
SELECT i.*, p.path
FROM sampled_inodes i
JOIN path p ON (
    i.medium_hash = p.medium_hash AND
    i.dev = p.dev AND
    i.ino = p.ino
)
ORDER BY RANDOM()
LIMIT 1
FOR UPDATE OF i SKIP LOCKED;</code></pre>
              </div>
              <p class="text-sm text-blue-700 mt-4">
                This implementation provides the optimal balance of speed, randomness quality, and production readiness
                for the 12-million-row inode table environment.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- References -->
      <section class="py-16 bg-white border-t border-gray-200">
        <div class="container mx-auto px-6">
          <div class="max-w-4xl mx-auto">
            <h2 class="font-tiempos text-2xl font-bold text-gray-900 mb-8">References</h2>
            <ul class="space-y-3 text-sm text-gray-700">
              <li id="ref-25">
                <span class="font-medium">[25]</span>
                <a href="https://tpetry.me/articles/how-to-optimize-order-by-random" class="citation-link" target="_blank">
                  How to Optimize ORDER BY RANDOM - tpetry.me
                </a>
              </li>
              <li id="ref-69">
                <span class="font-medium">[69]</span>
                <a href="https://stackoverflow.com/questions/8674718/best-way-to-select-random-rows-postgresql" class="citation-link" target="_blank">
                  Best Way to Select Random Rows - PostgreSQL Stack Overflow
                </a>
              </li>
              <li id="ref-422">
                <span class="font-medium">[422]</span>
                <a href="https://render.com/blog/postgresql-random-samples-big-tables" class="citation-link" target="_blank">
                  PostgreSQL Random Samples from Big Tables - Render Blog
                </a>
              </li>
              <li id="ref-423">
                <span class="font-medium">[423]</span>
                <a href="https://www.modb.pro/db/98436" class="citation-link" target="_blank">
                  PostgreSQL Performance Analysis - MODB Pro
                </a>
              </li>
              <li id="ref-443">
                <span class="font-medium">[443]</span>
                <a href="https://www.redpill-linpro.com/techblog/2021/05/07/getting-random-rows-faster.html" class="citation-link" target="_blank">
                  Getting Random Rows Faster - Redpill Linpro Tech Blog
                </a>
              </li>
              <li id="ref-448">
                <span class="font-medium">[448]</span>
                <a href="https://alexstoica.com/blog/postgres-select-for-update-perf" class="citation-link" target="_blank">
                  Postgres SELECT FOR UPDATE Performance - Alex Stoica
                </a>
              </li>
              <li id="ref-453">
                <span class="font-medium">[453]</span>
                <a href="https://wiki.postgresql.org/wiki/TABLESAMPLE_Implementation" class="citation-link" target="_blank">
                  TABLESAMPLE Implementation - PostgreSQL Wiki
                </a>
              </li>
              <li id="ref-455">
                <span class="font-medium">[455]</span>
                <a href="https://www.dbvis.com/thetable/sql-order-by-random-strategies-and-queries/" class="citation-link" target="_blank">
                  SQL ORDER BY RANDOM Strategies and Queries - DbVisualizer
                </a>
              </li>
              <li id="ref-456">
                <span class="font-medium">[456]</span>
                <a href="https://www.geeksforgeeks.org/postgresql/how-to-select-random-row-in-postgresql/" class="citation-link" target="_blank">
                  How to Select Random Row in PostgreSQL - GeeksforGeeks
                </a>
              </li>
            </ul>
          </div>
        </div>
      </section>
    </div>

    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Active TOC link highlighting
        window.addEventListener('scroll', function() {
            const sections = document.querySelectorAll('section[id]');
            const tocLinks = document.querySelectorAll('.toc-link');

            let currentSection = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (window.pageYOffset >= sectionTop - 100) {
                    currentSection = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentSection) {
                    link.classList.add('active');
                }
            });
        });

        // Initialize Mermaid with custom config
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#dbeafe',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#3b82f6',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#ffffff',
                background: '#ffffff',
                mainBkg: '#ffffff',
                secondBkg: '#f8fafc',
                tertiaryBkg: '#f1f5f9',
                primaryBorderColor: '#3b82f6',
                primaryTextColor: '#1f2937',
                secondaryTextColor: '#374151',
                tertiaryTextColor: '#6b7280',
                lineColor: '#6b7280',
                textColor: '#1f2937',
                THEME_COLOR_LIMIT: 12,
                fontFamily: 'Inter, sans-serif',
                fontSize: '13px'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 80,
                diagramPadding: 20
            },
            gantt: {
                useMaxWidth: true
            },
            journey: {
                useMaxWidth: true
            },
            timeline: {
                useMaxWidth: true
            },
            fontFamily: 'Inter, sans-serif',
            fontSize: '13px'
        });

        // Initialize Mermaid Controls for zoom and pan
        function initializeMermaidControls() {
            const containers = document.querySelectorAll('.mermaid-container');

            containers.forEach(container => {
            const mermaidElement = container.querySelector('.mermaid');
            let scale = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;

            // 触摸相关状态
            let isTouch = false;
            let touchStartTime = 0;
            let initialDistance = 0;
            let initialScale = 1;
            let isPinching = false;

            // Zoom controls
            const zoomInBtn = container.querySelector('.zoom-in');
            const zoomOutBtn = container.querySelector('.zoom-out');
            const resetBtn = container.querySelector('.reset-zoom');
            const fullscreenBtn = container.querySelector('.fullscreen');

            function updateTransform() {
                mermaidElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;

                if (scale > 1) {
                container.classList.add('zoomed');
                } else {
                container.classList.remove('zoomed');
                }

                mermaidElement.style.cursor = isDragging ? 'grabbing' : 'grab';
            }

            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                scale = Math.min(scale * 1.25, 4);
                updateTransform();
                });
            }

            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                scale = Math.max(scale / 1.25, 0.3);
                if (scale <= 1) {
                    translateX = 0;
                    translateY = 0;
                }
                updateTransform();
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
                });
            }

            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                });
            }

            // Mouse Events
            mermaidElement.addEventListener('mousedown', (e) => {
                if (isTouch) return; // 如果是触摸设备，忽略鼠标事件

                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                mermaidElement.style.cursor = 'grabbing';
                updateTransform();
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging && !isTouch) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging && !isTouch) {
                isDragging = false;
                mermaidElement.style.cursor = 'grab';
                updateTransform();
                }
            });

            document.addEventListener('mouseleave', () => {
                if (isDragging && !isTouch) {
                isDragging = false;
                mermaidElement.style.cursor = 'grab';
                updateTransform();
                }
            });

            // 获取两点之间的距离
            function getTouchDistance(touch1, touch2) {
                return Math.hypot(
                touch2.clientX - touch1.clientX,
                touch2.clientY - touch1.clientY
                );
            }

            // Touch Events - 触摸事件处理
            mermaidElement.addEventListener('touchstart', (e) => {
                isTouch = true;
                touchStartTime = Date.now();

                if (e.touches.length === 1) {
                // 单指拖动
                isPinching = false;
                isDragging = true;

                const touch = e.touches[0];
                startX = touch.clientX - translateX;
                startY = touch.clientY - translateY;

                } else if (e.touches.length === 2) {
                // 双指缩放
                isPinching = true;
                isDragging = false;

                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                initialDistance = getTouchDistance(touch1, touch2);
                initialScale = scale;
                }

                e.preventDefault();
            }, { passive: false });

            mermaidElement.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isDragging && !isPinching) {
                // 单指拖动
                const touch = e.touches[0];
                translateX = touch.clientX - startX;
                translateY = touch.clientY - startY;
                updateTransform();

                } else if (e.touches.length === 2 && isPinching) {
                // 双指缩放
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = getTouchDistance(touch1, touch2);

                if (initialDistance > 0) {
                    const newScale = Math.min(Math.max(
                    initialScale * (currentDistance / initialDistance),
                    0.3
                    ), 4);
                    scale = newScale;
                    updateTransform();
                }
                }

                e.preventDefault();
            }, { passive: false });

            mermaidElement.addEventListener('touchend', (e) => {
                // 重置状态
                if (e.touches.length === 0) {
                isDragging = false;
                isPinching = false;
                initialDistance = 0;

                // 延迟重置isTouch，避免鼠标事件立即触发
                setTimeout(() => {
                    isTouch = false;
                }, 100);
                } else if (e.touches.length === 1 && isPinching) {
                // 从双指变为单指，切换为拖动模式
                isPinching = false;
                isDragging = true;

                const touch = e.touches[0];
                startX = touch.clientX - translateX;
                startY = touch.clientY - translateY;
                }

                updateTransform();
            });

            mermaidElement.addEventListener('touchcancel', (e) => {
                isDragging = false;
                isPinching = false;
                initialDistance = 0;

                setTimeout(() => {
                isTouch = false;
                }, 100);

                updateTransform();
            });

            // Enhanced wheel zoom with better center point handling
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = container.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.min(Math.max(scale * delta, 0.3), 4);

                // Adjust translation to zoom towards center
                if (newScale !== scale) {
                const scaleDiff = newScale / scale;
                translateX = translateX * scaleDiff;
                translateY = translateY * scaleDiff;
                scale = newScale;

                if (scale <= 1) {
                    translateX = 0;
                    translateY = 0;
                }

                updateTransform();
                }
            });

            // Initialize display
            updateTransform();
            });
        }

        // Initialize Mermaid controls after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMermaidControls();
        });

        // Add active class to TOC links based on scroll position
        window.addEventListener('scroll', function() {
            const sections = document.querySelectorAll('section[id]');
            const tocLinks = document.querySelectorAll('.toc-link');

            let currentSection = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (window.pageYOffset >= sectionTop - 100) {
                    currentSection = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentSection) {
                    link.classList.add('active');
                }
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
  </body>

</html>
