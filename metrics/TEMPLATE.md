<!--
Author: PB and Claude
Date: Thu 10 Oct 2025
License: (c) HRDAG, 2025, GPL-2 or newer

------
ntt/metrics/TEMPLATE.md
-->

# Metrics: <medium_hash_short> - <YYYY-MM-DD>

**Medium:** <hash_short> (<full_hash>)
**Human name:** <medium_human from database>
**Size:** <IMG file size>
**Completed:** YYYY-MM-DD HH:MM
**Total duration:** <HH:MM from start to archive>

---

## Phase Timing

| Phase | Duration | Status |
|-------|----------|--------|
| Pre-flight | <time> | pass/fail |
| Enumeration | <time> | pass/fail |
| Loading | <time> | pass/fail |
| Copying | <time> | pass/fail |
| Archive | <time> | pass/fail |

**Deduplication time:** <Xs from loader logs>

---

## Database Metrics

**Query used:**
```sql
SELECT
  COUNT(*) as total_inodes,
  COUNT(*) FILTER (WHERE copied = true) as copied,
  COUNT(*) FILTER (WHERE skip_reason IS NOT NULL) as skipped,
  COUNT(*) FILTER (WHERE skip_reason LIKE '%DIAGNOSTIC_SKIP%') as diagnostic_skips
FROM inode WHERE medium_hash = '<hash>';
```

**Results:**
- Total inodes: <N>
- Copied successfully: <N> (<percent>%)
- Skipped (with reason): <N> (<percent>%)
  - Diagnostic auto-skips: <N>
  - Other skips: <N>
- Failed/unclaimed: <N>

---

## Deduplication Analysis

**Query used:**
```sql
SELECT
  COUNT(DISTINCT i.hash) as unique_files,
  COUNT(*) as total_files,
  (1.0 - COUNT(DISTINCT i.hash)::float / COUNT(*)::float) * 100 as dedup_rate
FROM inode i
WHERE medium_hash = '<hash>' AND copied = true AND type = 'f';
```

**Results:**
- Total files copied: <N>
- Unique file hashes: <N>
- Deduplication rate: <percent>%
  - <N> files (<percent>%) linked to existing content in by-hash/
  - <N> files (<percent>%) were new unique content

---

## Copy Performance

**Throughput:**
- Total bytes copied: <N> GB
- Copy duration: <time>
- Average throughput: <N> MB/s

**Calculation:**
```
Total size: ls -lh /data/cold/archived/<hash>/ | awk ...
Copy time: From copier logs or processing-queue.md
Throughput: total_bytes / time_seconds
```

**Workers used:** <N> (worker IDs: <list>)

---

## Diagnostic Events

**Query used:**
```bash
sudo grep "DIAGNOSTIC CHECKPOINT\|SKIPPED" /var/log/ntt-copier.log | grep <hash>
```

**Findings:**
- Diagnostic checkpoints triggered: <N>
- Auto-skips executed: <N>
- Error patterns:
  - BEYOND_EOF: <N>
  - IO_ERROR: <N>
  - FAT_ERROR: <N>
  - Other: <N>

**Sample diagnostic log:**
```
<paste 2-3 representative log lines if any>
```

---

## Archive Metrics

**Archive file:** `/data/cold/img-read/<hash>.tar.zst`

- Original IMG size: <size>
- Compressed archive size: <size>
- Compression ratio: <ratio>:1

**Calculation:**
```bash
original=$(stat -f%z /data/fast/img/<hash>.img)  # before archival
compressed=$(stat -f%z /data/cold/img-read/<hash>.tar.zst)
ratio=$(echo "scale=2; $original / $compressed" | bc)
```

---

## Issues Encountered

**Bugs filed:** <list BUG-NNN or "none">
**Problems recorded in DB:** <yes/no>

**If problems:**
```sql
SELECT jsonb_pretty(problems) FROM medium WHERE medium_hash = '<hash>';
```

**Result:**
```json
<paste problems JSONB if any>
```

---

## Success Assessment

**Overall:** SUCCESS | PARTIAL | FAILED

**Criteria from media-processing-plan.md:**
- [ ] Raw file created (enumeration)
- [ ] No duplicate paths
- [ ] Partitions created (loading)
- [ ] Deduplication <10s
- [ ] FK indexes present
- [ ] Files archived to /data/cold/archived/
- [ ] Deduplication working
- [ ] Compressed archive created
- [ ] Database marked complete (copy_done IS NOT NULL)
- [ ] Source files cleaned up

**Notes:**
<Any observations about success/failure, workarounds used, manual intervention required>

---

## Recommendations

**For this medium:**
<Any specific notes - e.g., "FAT corruption but 95% of files recovered successfully">

**For future processing:**
<Patterns that might apply to other media - e.g., "Large ext3 disks benefit from multiple copier workers">

**For dev-claude:**
<Potential improvements - e.g., "Consider increasing batch size for disks >10K inodes">

---

**Generated by:** metrics-claude
**References:**
- Database queries: `metrics/QUERIES.md`
- Processing log: `processing-queue.md`
- Bug reports: `bugs/` (if any)
